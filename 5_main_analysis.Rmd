---
title: 'A randomised trial to estimate the effect of funding on research productivity: Main analysis'
author: "Adrian Barnett"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document:
    toc: true
    toc_depth: 1
    reference_docx: rmarkdown-styles-reference.docx
---

```{r setup, include=FALSE}
# using formatting in Word document (see above)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, error=FALSE, comment='', dpi=400)
options(width=1000) # Wide pages
options(scipen=999) # avoid scientific presentation
source('99_functions.R')
library(dplyr)
library(tidyr)
library(stringr)
library(janitor) # for tables with column totals
library(flextable)
library(survival)
library(broom)
# Bayes packages:
library(nimble)
library(ggmcmc)
library(coda)
# plotting packages:
library(survminer)
library(gridExtra)
library(ggplot2)
g.theme = theme_bw() + theme(panel.grid.minor = element_blank())

# get the analysis-read data sets on funding and papers; with treatment variable, baseline counts and denominators
source('4_get_data.R')
## paper data, annual
only_consent = FALSE # big switch that impacts all results
analysis_ready = add_treatment_censored(in_random = researchers, 
                                        only_consent = only_consent,
                                        monthly = FALSE, 
                                        in_biblio = paper_counts)
## paper data, monthly
analysis_ready_monthly = add_treatment_censored(in_random = researchers, 
                                                only_consent = only_consent,
                                                in_biblio = paper_counts_monthly,
                                                monthly = TRUE)
# quick fix for duplicated months/years (checked that all months and years are the same)
analysis_ready_monthly = dplyr::select(analysis_ready_monthly, -month.x, -year.x, -year.y) %>%
  rename('month' = 'month.y')
## citation data, annual 
analysis_ready_citations = add_treatment_censored(in_random = researchers, 
                                                only_consent = only_consent,
                                                in_biblio = citations,
                                                citations = TRUE,
                                                monthly = FALSE)
# quick fix for one person (#73) with missing data
f = season::yrfraction(scopus_date_citations)
analysis_ready_citations = mutate(analysis_ready_citations, 
  denom_scopus = ifelse(is.na(scopus)==TRUE, f, denom_scopus),
  scopus = ifelse(is.na(scopus)==TRUE, 0, scopus), 
  b_scopus = ifelse(is.na(b_scopus), 0, b_scopus))
## citation data, per paper 
analysis_ready_citations_per_paper = add_treatment_censored(in_random = researchers, 
                                                only_consent = only_consent,
                                                in_biblio = citations_per_paper,
                                                citations = TRUE,
                                                baseline_stat = 'last',
                                                monthly = FALSE)
# quick fix for one person (#73) with missing data
analysis_ready_citations_per_paper = mutate(analysis_ready_citations_per_paper, 
  denom_scopus = 1, # no need for offset as fewer papers cancel fewer citations
  scopus = ifelse(is.na(scopus)==TRUE, 0, scopus), 
  b_scopus = ifelse(is.na(b_scopus), 0, b_scopus))
## altmetric data, average per paper
analysis_ready_altmetric = add_treatment_censored(in_random = researchers, 
                                        only_consent = only_consent,
                                        is_altmetric = TRUE,
                                        monthly = FALSE, 
                                        baseline_stat = 'mean', 
                                        in_biblio = altmetric_average)
# quick fix for small amount of missing
analysis_ready_altmetric = mutate(analysis_ready_altmetric, 
  denom_altmetric = 1, # no need for offset as fewer papers cancel fewer citations
  altmetric = ifelse(is.na(altmetric )==TRUE, 0, altmetric), 
  b_altmetric = ifelse(is.na(b_altmetric), 0, b_altmetric))
## employment
analysis_ready_employment = add_treatment_employment(in_random = researchers, 
                            only_consent = only_consent)
```

This analysis uses bibliographic data from researchers. 
The follow-up dates were `r format(scholar_date, '%d-%b-%Y')` for _Google Scholar_, `r format(scopus_date, '%d-%b-%Y')` for _Scopus_, `r format(researchgate_date, '%d-%b-%Y')` for _researchgate_, and `r format(altmetric_date, '%d-%b-%Y')` for _Altmetric_. 

###### page break

# Yearly publication counts

First we examine the effect of funding on yearly publication counts. 

```{r, include=FALSE}
file = c('bayes', 'main_publication_counts')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_publications.R')
  save(results_main, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (yearly publication data)

```{r}
to_table = filter(results_main$table, 
    str_detect(parameter, pattern='beta|gamma')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

The table shows estimated percent changes, 95% credible intervals, and Bayesian posterior p-value.

As expected there was a strong effect of the number of papers a researcher had prior to randomisation on their post-randomisation output. 

There was no clear effect of funding, but the 95% credible interval is wide and includes meaningful increases in output (e.g., 20% increase). Hence we can't rule out that there is not a real and large effect of funding. 

## Time-varying treatment (yearly publication data)

We ran a model with a time-varying treatment effect.

```{r, include=FALSE}
file = c('bayes','model_time_varying')
outfile = make_file(file, only_consent = only_consent)
pilot = FALSE
if(outfile$exists == FALSE){
  source('99_nimble_publications_time_varying.R')
  save(results_time_varying, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

```{r}
time_varying =  filter(results_time_varying$table, str_detect(parameter, pattern='^diff')) %>%
  mutate(mean = 100*(exp(mean)- 1), # percent change
      lower = 100*(exp(lower)- 1),
      upper = 100*(exp(upper)- 1),
      years_since = str_remove_all(parameter, pattern='[^0-9]'),
      years_since = as.numeric(years_since) - 1) # minus 1 so that first year is zero
# remove later years with extreme uncertainty
#time_varying = filter(time_varying, years_since <=4)

#
splot_main = ggplot(data=time_varying, aes(x=years_since, y=mean, ymin=lower, ymax=upper))+
    geom_hline(lty = 2, yintercept=0)+
    geom_ribbon(alpha = 0.2)+
    geom_point(size=2)+
    geom_line(size = 1.1)+
    xlab('Years since funding')+
    ylab('Percent change in publications')+
    theme_bw()+
    theme(panel.grid.minor = element_blank())
splot_main
```


The plot shows no clear benefit to funding on publication counts over time since funding. The 95% credible intervals become wider as the years since funding increases because there are fewer observations and hence more uncertainty (see appendix).

### Table of time-varying estimates (yearly publication data)

```{r}
table = mutate(time_varying,
               lower = roundz(lower, 1),
               upper = roundz(upper, 1),
               ci = paste(lower, ' to ', upper, sep=''),
               pvalue = format.pval(pvalue, digits=2, eps=0.001)) %>%
  dplyr::select(years_since, mean, ci, pvalue) %>%
  rename('years since funding' ='years_since') %>%
  flextable() %>%
  theme_tron_legacy() %>%
  colformat_double(j=2, digits=1) %>%
  autofit()
table
```


### Table of model estimates (yearly publication data, time-varying treatment)

```{r}
to_table = filter(results_time_varying$table, 
    str_detect(parameter, pattern='beta|delta|lambda|gamma|slope.diff')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

The table shows no clear effect of funding or for the interaction between funding and years since funding. 

###### page break

# Monthly publication counts

The models above used annual publication counts, but the funding announcements happened during the year and we assumed the treatment effect began in the year of funding. Hence some papers from the funded year were likely pre-randomisation. To somewhat account for this we used a model of monthly counts instead of annual counts. However, we could only do this for the _Scopus_ and _researchgate_ databases which had the publication date.

```{r}
file = c('bayes', 'publication_counts_monthly')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  pilot = FALSE # run big model
  source('99_nimble_publications_monthly.R')
  save(results_monthly, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (monthly publication data)

```{r}
to_table = filter(results_monthly$table, 
    str_detect(parameter, pattern='zeta|beta|gamma')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue) 
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

The results show no clear effect of funding. 

We added January as a predictor because exploratory analysis showed a clear increase in papers on this month. This is because some journals do not include an exact month in the date and all papers have a date of January.


###### page break

# Time-varying treatment for monthly publication data

The previous model assumed a fixed effect for funding. Here we allow the effect of funding to vary over time.

```{r}
file = c('bayes','real_model_monthly_varying')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  pilot = FALSE # run big model
  source('99_nimble_publications_monthly_time_varying.R')
  save(results_yrmon_monthly_varying, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (monthly publication data)

```{r}
to_table = filter(results_yrmon_monthly_varying$table, 
    str_detect(parameter, pattern='zeta|beta|lambda|delta|gamma|slope.diff')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```


```{r}
time_varying =  filter(results_yrmon_monthly_varying$table, str_detect(parameter, pattern='^diff')) %>%
  mutate(mean = 100*(exp(mean)- 1), # percent change
      lower = 100*(exp(lower)- 1),
      upper = 100*(exp(upper)- 1),
      months_since = str_remove_all(parameter, pattern='[^0-9]'),
      months_since = as.numeric(months_since),
      years_since = months_since*12) # minus 1 so that first year is zero

#
splot_main = ggplot(data=time_varying, aes(x=years_since, y=mean, ymin=lower, ymax=upper))+
    geom_hline(lty = 2, yintercept=0)+
    geom_ribbon(alpha = 0.2)+
    geom_point(size=2)+
    geom_line(size = 1.1)+
    xlab('Years since funding')+
    ylab('Percent change in publications')+
    theme_bw()+
    theme(panel.grid.minor = element_blank())
splot_main
```

### Table of time-varying estimates (citation data)

```{r}
table = mutate(time_varying,
               lower = roundz(lower, 1),
               upper = roundz(upper, 1),
               ci = paste(lower, ' to ', upper, sep=''),
               pvalue = format.pval(pvalue, digits=2, eps=0.001)) %>%
  dplyr::select(years_since, mean, ci, pvalue) %>%
  rename('years since funding' ='years_since') %>%
  flextable() %>%
  theme_tron_legacy() %>%
  colformat_double(j=2, digits=1) %>%
  autofit()
table
```

###### page break

# Citations

```{r, include=FALSE}
file = c('bayes', 'main_citation_counts')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_citations.R')
  save(results_citations, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (citation data)

```{r}
to_table = filter(results_citations$table, 
    str_detect(parameter, pattern='beta|gamma')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

###### page break

# Time-varying citations

```{r, include=FALSE}
file = c('bayes', 'main_citation_time_varying')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_citations_time_varying.R')
  save(results_citations_time_varying, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (time-varying citation data)

```{r}
to_table = filter(results_citations_time_varying$table, 
    str_detect(parameter, pattern='beta|gamma|delta|lambda|slope.diff')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

```{r}
time_varying =  filter(results_citations_time_varying$table, str_detect(parameter, pattern='^diff')) %>%
  mutate(mean = 100*(exp(mean)- 1), # percent change
      lower = 100*(exp(lower)- 1),
      upper = 100*(exp(upper)- 1),
      months_since = str_remove_all(parameter, pattern='[^0-9]'),
      months_since = as.numeric(months_since),
      years_since = months_since*12) # minus 1 so that first year is zero

#
splot_main = ggplot(data=time_varying, aes(x=years_since, y=mean, ymin=lower, ymax=upper))+
    geom_hline(lty = 2, yintercept=0)+
    geom_ribbon(alpha = 0.2)+
    geom_point(size=2)+
    geom_line(size = 1.1)+
    xlab('Years since funding')+
    ylab('Percent change in citations')+
    theme_bw()+
    theme(panel.grid.minor = element_blank())
splot_main
```

###### page break

# Citation counts per paper

The following results examine citation counts per paper. The outcome was created by dividing the cumulative number of citations over years by the cumulative number of papers. These data use a single database and so are not fitted as a multivariate model.

```{r, include=FALSE}
file = c('bayes', 'main_citation_per_paper')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_citations_per_paper.R')
  save(results_citations_per_paper, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (citations per paper)

```{r}
to_table = filter(results_citations_per_paper$table, 
    str_detect(parameter, pattern='beta|gamma')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```

###### page break

# Time-varying citations per paper

```{r, include=FALSE}
file = c('bayes', 'main_citation_per_paper_time_varying')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_citations_per_paper_time_varying.R')
  save(results_citations_per_paper_time_varying, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

```{r}
time_varying =  filter(results_citations_per_paper_time_varying$table, str_detect(parameter, pattern='^diff')) %>%
  mutate(mean = 100*(exp(mean)- 1), # percent change
      lower = 100*(exp(lower)- 1),
      upper = 100*(exp(upper)- 1),
      months_since = str_remove_all(parameter, pattern='[^0-9]'),
      months_since = as.numeric(months_since),
      years_since = months_since-1) #  /
#
splot_main = ggplot(data=time_varying, aes(x=years_since, y=mean, ymin=lower, ymax=upper))+
    geom_hline(lty = 2, yintercept=0)+
    geom_ribbon(alpha = 0.2)+
    geom_point(size=2)+
    geom_line(size = 1.1)+
    xlab('Years since funding')+
    ylab('Percent change in citations per paper')+
    theme_bw()+
    theme(panel.grid.minor = element_blank())
splot_main
```

### Table of estimates (citations per paper)

```{r}
to_table = filter(results_citations_per_paper_time_varying$table, 
    str_detect(parameter, pattern='beta|gamma|delta|lambda|slope.diff')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```


###### page break

# Altmetric score

```{r, include=FALSE}
file = c('bayes', 'altmetric')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_altmetric.R')
  save(results_altmetric, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (altmetric)

```{r}
to_table = filter(results_altmetric$table, 
    str_detect(parameter, pattern='beta|gamma')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```


###### page break

# Altmetric score time-varying

```{r, include=FALSE}
file = c('bayes', 'altmetric_time_varying')
outfile = make_file(file, only_consent = only_consent)
if(outfile$exists == FALSE){
  # model choices:
  pilot = FALSE # run big model
  source('99_nimble_altmetric_time_varying.R')
  save(results_altmetric_time_varying, file = outfile$file)
}
if(outfile$exists == TRUE){
  load(outfile$file)
}
```

### Table of estimates (altmetric, time-varying)

```{r}
to_table = filter(results_altmetric_time_varying$table, 
    str_detect(parameter, pattern='beta|gamma|lambda|delta|slope.diff')) %>% # do not show intercept
  mutate(term = parameter_rename(parameter, papers=FALSE),
  pvalue = format.pval(pvalue, digits=2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(term, mean, ci, pvalue)
ftab = flextable(to_table)%>%
  autofit() %>%
  theme_box()
ftab
```


###### page break

# Employment

```{r}
# assume still employed if the entered the randomisation
# model probability of being unemployed (outcome = zero)
smodel = coxph(Surv(time, outcome==0) ~ I(funded=='Funded') + cluster(number), data = analysis_ready_employment)
ests = tidy(smodel, conf.int=TRUE, exponentiate = TRUE) %>%
  select(term, estimate, conf.low, conf.high)
ests$term = 'Funded'
ftab = flextable(ests) %>%
  theme_box() %>%
  autofit() %>%
  colformat_double(j=2:4, digits=2)
ftab
```

We use a survival model to examine employment. We only collected employment data at the end of the follow-up, meaning we did not have repeated data for researchers who submitted multiple applications. We assumed they were still employed as a researcher if they re-applied and were entered into the Lottery.

The table above shows the hazard ratio and 95% confidence interval using the outcome of not employed. A hazard ratio above 1 indicates a higher probability of no longer being employed.

The plot below shows the Kaplan-Meier curves for the two groups.

```{r, fig.height=7}
sfit = survfit(Surv(time, outcome==0) ~ funded + cluster(number), data=analysis_ready_employment)
ggsurvplot(sfit, 
           conf.int = TRUE,
           palette = c("skyblue", "indianred2"),
           legend.labs = c("Funded", "Not funded"),
           xlab = "Time since randomisation, years",
           risk.table = TRUE,
           data = analysis_ready_employment)
```

###### page break

# Summary tables

#### Main effect of funding

The table below shows the main effect of funding.

```{r}
t1 = filter(results_main$table, 
    str_detect(parameter, pattern='gamma'))
t2 = filter(results_time_varying$table, 
    str_detect(parameter, pattern='gamma'))
t3 = filter(results_monthly$table, 
    str_detect(parameter, pattern='gamma'))
t4 = filter(results_yrmon_monthly_varying$table, 
    str_detect(parameter, pattern='gamma'))
t5 = filter(results_citations$table, 
    str_detect(parameter, pattern='gamma'))
t6 = filter(results_citations_time_varying$table, 
    str_detect(parameter, pattern='gamma'))
t7 = filter(results_citations_per_paper$table, 
    str_detect(parameter, pattern='gamma'))
t8 = filter(results_citations_per_paper_time_varying$table, 
    str_detect(parameter, pattern='gamma'))
t9 = filter(results_altmetric$table, 
    str_detect(parameter, pattern='gamma'))
t10 = filter(results_altmetric_time_varying $table, 
    str_detect(parameter, pattern='gamma'))
summary_table = bind_rows(t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, .id='id') %>%
  mutate(
    outcome = case_when(
      id == 1 ~ 'Publications',
      id == 2 ~ 'Publications',
      id == 3 ~ 'Publications',
      id == 4 ~ 'Publications',
      id == 5 ~ 'Citations',
      id == 6 ~ 'Citations',
      id == 7 ~ 'Citations per paper',
      id == 8 ~ 'Citations per paper',
      id == 9 ~ 'Altmetric',
      id == 10 ~ 'Altmetric'
  ),
  time = case_when(
      id == 1 ~ 'Yearly',
      id == 2 ~ 'Yearly',
      id == 3 ~ 'Monthly',
      id == 4 ~ 'Monthly',
      id == 5 ~ 'Yearly',
      id == 6 ~ 'Yearly',
      id == 7 ~ 'Yearly',
      id == 8 ~ 'Yearly',
      id == 9 ~ 'Yearly',
      id == 10 ~ 'Yearly'
  ),
  time_varying = case_when(
      id == 1 ~ 'No',
      id == 2 ~ 'Yes',
      id == 3 ~ 'No',
      id == 4 ~ 'Yes',
      id == 5 ~ 'No',
      id == 6 ~ 'Yes',
      id == 7 ~ 'No',
      id == 8 ~ 'Yes',
      id == 9 ~ 'No',
      id == 10 ~ 'Yes'
  )) %>%
  mutate(pvalue = format.pval(pvalue, digits = 2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(outcome, time, time_varying, mean, ci, pvalue)
ftab = flextable(summary_table) %>%
  theme_box() %>%
  autofit() %>%
  merge_v(j=1:2)
ftab
```

#### Change in the effect of funding over time

The table below shows the main effect of funding.

```{r}
t2 = filter(results_time_varying$table, 
    str_detect(parameter, pattern='slope.diff'))
t4 = filter(results_yrmon_monthly_varying$table, 
    str_detect(parameter, pattern='slope.diff'))
t6 = filter(results_citations_time_varying$table, 
    str_detect(parameter, pattern='slope.diff'))
t8 = filter(results_citations_per_paper_time_varying$table, 
    str_detect(parameter, pattern='slope.diff'))
t10 = filter(results_altmetric_time_varying$table, 
    str_detect(parameter, pattern='slope.diff'))
summary_table = bind_rows(t2, t4, t6, t8, t10, .id='id') %>%
  mutate(
    outcome = case_when(
      id == 1 ~ 'Publications',
      id == 2 ~ 'Publications',
      id == 3 ~ 'Citations',
      id == 4 ~ 'Citations per paper',
      id == 5 ~ 'Altmetric'
  ),
  time = case_when(
      id == 1 ~ 'Yearly',
      id == 2 ~ 'Monthly',
      id == 3 ~ 'Yearly',
      id == 4 ~ 'Yearly',
      id == 5 ~ 'Yearly'
  )) %>%
  mutate(pvalue = format.pval(pvalue, digits = 2, eps=0.0001),
    mean = 100*(exp(mean)- 1), # percent change
           lower = 100*(exp(lower)- 1),
           upper = 100*(exp(upper)- 1),
  mean = roundz(mean, 1), # rounding
         lower = roundz(lower, 1),
         upper = roundz(upper, 1),
         ci = paste(lower , ' to ' , upper, sep='')) %>%
  dplyr::select(outcome, time, mean, ci, pvalue)
ftab = flextable(summary_table) %>%
  theme_box() %>%
  autofit() %>%
  merge_v(j=1:2)
ftab
```

###### page break

# Appendix

Here we show some additional results for: 1) variance-covariance matrix for the databases, 2) the model residuals.

### Variance-covariance matrix (yearly publication data)

```{r}
cmat = mutate(results_main$covmat, 
              row = case_when(
                row==1 ~ 'Scholar',
                row==2 ~ 'Scopus',
                row==3 ~ 'Researchgate'
              ))
names(cmat) = c('row','Scholar','Scopus','Researchgate')
ftab  = flextable(cmat) %>%
  colformat_double(digits=2) %>%
  autofit() %>%
  theme_box()
ftab
```

### Residual checks (yearly publication data)

```{r, fig.width=8}
res = results_main$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')+
  facet_wrap(~database, scales='free')
hplot
```

The histograms are centered on zero and roughly symmetric. 

The relatively large negative residual in the Scopus database is for a relatively experienced researcher with zero outputs in 2022.

### Residual checks (yearly publication data, time-varying effect)

```{r, fig.width=8}
res = results_time_varying$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')+
  facet_wrap(~database, scales='free')
hplot
```

The histograms are centered on zero and roughly symmetric. 

### Residual checks (monthly publication data)

```{r, fig.width=8}
res = results_monthly$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')+
  facet_wrap(~database, scales='free')
hplot
#
```

The pattern in the shape of the residuals arises from the large number of months with zero publications. This causes a mode in the residuals and a loss of smooth shape. There was no clear pattern in the residuals by calendar time or years since funding.

### Residual checks (citations)

```{r, fig.width=8}
res = results_citations$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')
hplot
```

The three relatively large positive citations are for the most recent three years of the same researcher. 

### Residual checks (time-varying citations)

```{r, fig.width=8}
res = results_citations_time_varying$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')
hplot
```


### Residual checks (citations per paper)

```{r, fig.width=8}
res = results_citations_per_paper$residuals
hplot = ggplot(data=res, aes(x=residual))+
  geom_histogram(col='grey44', fill='skyblue')+
  g.theme+
  xlab('Residual')+
  ylab('Count')
hplot
```

### Researcher numbers over time

The plot below shows the number of researchers by group and years since funding. The numbers drop off with longer follow-up.

```{r}
tab = group_by(analysis_ready, funded, years_since) %>%
  tally() %>%
  mutate(years_since = years_since - 1)
ftab = rename(tab, 'number of\nresearchers' = 'n') %>%
  flextable() %>%
  merge_v(j=1) %>%
  theme_box() %>%
  autofit()
#ftab
tplot = ggplot(data=tab, aes(x=years_since, y=n, col=factor(funded)))+
  geom_line(size=1.05)+
  geom_point(size=2.5)+
  scale_color_manual(NULL, values=c('dark orange','navy'))+
  ylab('Number of researchers')+
  xlab('Years since randomisation')+
  g.theme+
  theme(panel.grid.minor=element_blank(),
        legend.position = c(0.85, 0.85))
tplot
jpeg('figures/researchers_over_time.jpg', width=5, height=4, units='in', quality = 100, res=400)
print(tplot)
invisible(dev.off())
```


```{r}
years_follow = group_by(analysis_ready, number) %>%
  summarise(start = min(year)) %>%
  mutate(years = 2022.5 - start -0.5) %>% # take of half for funding announcement
  summarise(total = sum(years))
```

The total years of follow-up was `r years_follow$total`.
